import{a as Y,S as M,b as Ce,T as k,P as ce,N as be}from"./prosemirror-state-196a664c.js";import{F as A,S as v}from"./prosemirror-model-dd95f3ae.js";import{a as K,D as ae}from"./prosemirror-view-90e8c06d.js";import{a as ye}from"./prosemirror-keymap-f78d9d43.js";import{T as Se}from"./prosemirror-transform-8da7cd1c.js";var X,V;if(typeof WeakMap<"u"){let e=new WeakMap;X=t=>e.get(t),V=(t,n)=>(e.set(t,n),n)}else{const e=[];let n=0;X=o=>{for(let l=0;l<e.length;l+=2)if(e[l]==o)return e[l+1]},V=(o,l)=>(n==10&&(n=0),e[n++]=o,e[n++]=l)}var C=class{constructor(e,t,n,o){this.width=e,this.height=t,this.map=n,this.problems=o}findCell(e){for(let t=0;t<this.map.length;t++){const n=this.map[t];if(n!=e)continue;const o=t%this.width,l=t/this.width|0;let s=o+1,r=l+1;for(let a=1;s<this.width&&this.map[t+a]==n;a++)s++;for(let a=1;r<this.height&&this.map[t+this.width*a]==n;a++)r++;return{left:o,top:l,right:s,bottom:r}}throw new RangeError(`No cell with offset ${e} found`)}colCount(e){for(let t=0;t<this.map.length;t++)if(this.map[t]==e)return t%this.width;throw new RangeError(`No cell with offset ${e} found`)}nextCell(e,t,n){const{left:o,right:l,top:s,bottom:r}=this.findCell(e);return t=="horiz"?(n<0?o==0:l==this.width)?null:this.map[s*this.width+(n<0?o-1:l)]:(n<0?s==0:r==this.height)?null:this.map[o+this.width*(n<0?s-1:r)]}rectBetween(e,t){const{left:n,right:o,top:l,bottom:s}=this.findCell(e),{left:r,right:a,top:i,bottom:c}=this.findCell(t);return{left:Math.min(n,r),top:Math.min(l,i),right:Math.max(o,a),bottom:Math.max(s,c)}}cellsInRect(e){const t=[],n={};for(let o=e.top;o<e.bottom;o++)for(let l=e.left;l<e.right;l++){const s=o*this.width+l,r=this.map[s];n[r]||(n[r]=!0,!(l==e.left&&l&&this.map[s-1]==r||o==e.top&&o&&this.map[s-this.width]==r)&&t.push(r))}return t}positionAt(e,t,n){for(let o=0,l=0;;o++){const s=l+n.child(o).nodeSize;if(o==e){let r=t+e*this.width;const a=(e+1)*this.width;for(;r<a&&this.map[r]<l;)r++;return r==a?s-1:this.map[r]}l=s}}static get(e){return X(e)||V(e,Ae(e))}};function Ae(e){if(e.type.spec.tableRole!="table")throw new RangeError("Not a table node: "+e.type.name);const t=Re(e),n=e.childCount,o=[];let l=0,s=null;const r=[];for(let c=0,f=t*n;c<f;c++)o[c]=0;for(let c=0,f=0;c<n;c++){const d=e.child(c);f++;for(let p=0;;p++){for(;l<o.length&&o[l]!=0;)l++;if(p==d.childCount)break;const w=d.child(p),{colspan:m,rowspan:x,colwidth:Z}=w.attrs;for(let D=0;D<x;D++){if(D+c>=n){(s||(s=[])).push({type:"overlong_rowspan",pos:f,n:x-D});break}const I=l+D*t;for(let z=0;z<m;z++){o[I+z]==0?o[I+z]=f:(s||(s=[])).push({type:"collision",row:c,pos:f,n:m-z});const _=Z&&Z[z];if(_){const H=(I+z)%t*2,O=r[H];O==null||O!=_&&r[H+1]==1?(r[H]=_,r[H+1]=1):O==_&&r[H+1]++}}}l+=m,f+=w.nodeSize}const u=(c+1)*t;let h=0;for(;l<u;)o[l++]==0&&h++;h&&(s||(s=[])).push({type:"missing",row:c,n:h}),f++}const a=new C(t,n,o,s);let i=!1;for(let c=0;!i&&c<r.length;c+=2)r[c]!=null&&r[c+1]<n&&(i=!0);return i&&xe(a,r,e),a}function Re(e){let t=-1,n=!1;for(let o=0;o<e.childCount;o++){const l=e.child(o);let s=0;if(n)for(let r=0;r<o;r++){const a=e.child(r);for(let i=0;i<a.childCount;i++){const c=a.child(i);r+c.attrs.rowspan>o&&(s+=c.attrs.colspan)}}for(let r=0;r<l.childCount;r++){const a=l.child(r);s+=a.attrs.colspan,a.attrs.rowspan>1&&(n=!0)}t==-1?t=s:t!=s&&(t=Math.max(t,s))}return t}function xe(e,t,n){e.problems||(e.problems=[]);const o={};for(let l=0;l<e.map.length;l++){const s=e.map[l];if(o[s])continue;o[s]=!0;const r=n.nodeAt(s);if(!r)throw new RangeError(`No cell with offset ${s} found`);let a=null;const i=r.attrs;for(let c=0;c<i.colspan;c++){const f=(l+c)%e.width,d=t[f*2];d!=null&&(!i.colwidth||i.colwidth[c]!=d)&&((a||(a=Me(i)))[c]=d)}a&&e.problems.unshift({type:"colwidth mismatch",pos:s,colwidth:a})}}function Me(e){if(e.colwidth)return e.colwidth.slice();const t=[];for(let n=0;n<e.colspan;n++)t.push(0);return t}function b(e){let t=e.cached.tableNodeTypes;if(!t){t=e.cached.tableNodeTypes={};for(const n in e.nodes){const o=e.nodes[n],l=o.spec.tableRole;l&&(t[l]=o)}}return t}var N=new Y("selectingCells");function T(e){for(let t=e.depth-1;t>0;t--)if(e.node(t).type.spec.tableRole=="row")return e.node(0).resolve(e.before(t+1));return null}function Ne(e){for(let t=e.depth;t>0;t--){const n=e.node(t).type.spec.tableRole;if(n==="cell"||n==="header_cell")return e.node(t)}return null}function S(e){const t=e.selection.$head;for(let n=t.depth;n>0;n--)if(t.node(n).type.spec.tableRole=="row")return!0;return!1}function W(e){const t=e.selection;if("$anchorCell"in t&&t.$anchorCell)return t.$anchorCell.pos>t.$headCell.pos?t.$anchorCell:t.$headCell;if("node"in t&&t.node&&t.node.type.spec.tableRole=="cell")return t.$anchor;const n=T(t.$head)||ve(t.$head);if(n)return n;throw new RangeError(`No cell found around position ${t.head}`)}function ve(e){for(let t=e.nodeAfter,n=e.pos;t;t=t.firstChild,n++){const o=t.type.spec.tableRole;if(o=="cell"||o=="header_cell")return e.doc.resolve(n)}for(let t=e.nodeBefore,n=e.pos;t;t=t.lastChild,n--){const o=t.type.spec.tableRole;if(o=="cell"||o=="header_cell")return e.doc.resolve(n-t.nodeSize)}}function q(e){return e.parent.type.spec.tableRole=="row"&&!!e.nodeAfter}function ze(e){return e.node(0).resolve(e.pos+e.nodeAfter.nodeSize)}function G(e,t){return e.depth==t.depth&&e.pos>=t.start(-1)&&e.pos<=t.end(-1)}function fe(e,t,n){const o=e.node(-1),l=C.get(o),s=e.start(-1),r=l.nextCell(e.pos-s,t,n);return r==null?null:e.node(0).resolve(s+r)}function E(e,t,n=1){const o={...e,colspan:e.colspan-n};return o.colwidth&&(o.colwidth=o.colwidth.slice(),o.colwidth.splice(t,n),o.colwidth.some(l=>l>0)||(o.colwidth=null)),o}function de(e,t,n=1){const o={...e,colspan:e.colspan+n};if(o.colwidth){o.colwidth=o.colwidth.slice();for(let l=0;l<n;l++)o.colwidth.splice(t,0,0)}return o}function ke(e,t,n){const o=b(t.type.schema).header_cell;for(let l=0;l<e.height;l++)if(t.nodeAt(e.map[n+l*e.width]).type!=o)return!1;return!0}var g=class extends M{constructor(e,t=e){const n=e.node(-1),o=C.get(n),l=e.start(-1),s=o.rectBetween(e.pos-l,t.pos-l),r=e.node(0),a=o.cellsInRect(s).filter(c=>c!=t.pos-l);a.unshift(t.pos-l);const i=a.map(c=>{const f=n.nodeAt(c);if(!f)throw RangeError(`No cell with offset ${c} found`);const d=l+c+1;return new Ce(r.resolve(d),r.resolve(d+f.content.size))});super(i[0].$from,i[0].$to,i),this.$anchorCell=e,this.$headCell=t}map(e,t){const n=e.resolve(t.map(this.$anchorCell.pos)),o=e.resolve(t.map(this.$headCell.pos));if(q(n)&&q(o)&&G(n,o)){const l=this.$anchorCell.node(-1)!=n.node(-1);return l&&this.isRowSelection()?g.rowSelection(n,o):l&&this.isColSelection()?g.colSelection(n,o):new g(n,o)}return k.between(n,o)}content(){const e=this.$anchorCell.node(-1),t=C.get(e),n=this.$anchorCell.start(-1),o=t.rectBetween(this.$anchorCell.pos-n,this.$headCell.pos-n),l={},s=[];for(let a=o.top;a<o.bottom;a++){const i=[];for(let c=a*t.width+o.left,f=o.left;f<o.right;f++,c++){const d=t.map[c];if(l[d])continue;l[d]=!0;const u=t.findCell(d);let h=e.nodeAt(d);if(!h)throw RangeError(`No cell with offset ${d} found`);const p=o.left-u.left,w=u.right-o.right;if(p>0||w>0){let m=h.attrs;if(p>0&&(m=E(m,0,p)),w>0&&(m=E(m,m.colspan-w,w)),u.left<o.left){if(h=h.type.createAndFill(m),!h)throw RangeError(`Could not create cell with attrs ${JSON.stringify(m)}`)}else h=h.type.create(m,h.content)}if(u.top<o.top||u.bottom>o.bottom){const m={...h.attrs,rowspan:Math.min(u.bottom,o.bottom)-Math.max(u.top,o.top)};u.top<o.top?h=h.type.createAndFill(m):h=h.type.create(m,h.content)}i.push(h)}s.push(e.child(a).copy(A.from(i)))}const r=this.isColSelection()&&this.isRowSelection()?e:s;return new v(A.from(r),1,1)}replace(e,t=v.empty){const n=e.steps.length,o=this.ranges;for(let s=0;s<o.length;s++){const{$from:r,$to:a}=o[s],i=e.mapping.slice(n);e.replace(i.map(r.pos),i.map(a.pos),s?v.empty:t)}const l=M.findFrom(e.doc.resolve(e.mapping.slice(n).map(this.to)),-1);l&&e.setSelection(l)}replaceWith(e,t){this.replace(e,new v(A.from(t),0,0))}forEachCell(e){const t=this.$anchorCell.node(-1),n=C.get(t),o=this.$anchorCell.start(-1),l=n.cellsInRect(n.rectBetween(this.$anchorCell.pos-o,this.$headCell.pos-o));for(let s=0;s<l.length;s++)e(t.nodeAt(l[s]),o+l[s])}isColSelection(){const e=this.$anchorCell.index(-1),t=this.$headCell.index(-1);if(Math.min(e,t)>0)return!1;const n=e+this.$anchorCell.nodeAfter.attrs.rowspan,o=t+this.$headCell.nodeAfter.attrs.rowspan;return Math.max(n,o)==this.$headCell.node(-1).childCount}static colSelection(e,t=e){const n=e.node(-1),o=C.get(n),l=e.start(-1),s=o.findCell(e.pos-l),r=o.findCell(t.pos-l),a=e.node(0);return s.top<=r.top?(s.top>0&&(e=a.resolve(l+o.map[s.left])),r.bottom<o.height&&(t=a.resolve(l+o.map[o.width*(o.height-1)+r.right-1]))):(r.top>0&&(t=a.resolve(l+o.map[r.left])),s.bottom<o.height&&(e=a.resolve(l+o.map[o.width*(o.height-1)+s.right-1]))),new g(e,t)}isRowSelection(){const e=this.$anchorCell.node(-1),t=C.get(e),n=this.$anchorCell.start(-1),o=t.colCount(this.$anchorCell.pos-n),l=t.colCount(this.$headCell.pos-n);if(Math.min(o,l)>0)return!1;const s=o+this.$anchorCell.nodeAfter.attrs.colspan,r=l+this.$headCell.nodeAfter.attrs.colspan;return Math.max(s,r)==t.width}eq(e){return e instanceof g&&e.$anchorCell.pos==this.$anchorCell.pos&&e.$headCell.pos==this.$headCell.pos}static rowSelection(e,t=e){const n=e.node(-1),o=C.get(n),l=e.start(-1),s=o.findCell(e.pos-l),r=o.findCell(t.pos-l),a=e.node(0);return s.left<=r.left?(s.left>0&&(e=a.resolve(l+o.map[s.top*o.width])),r.right<o.width&&(t=a.resolve(l+o.map[o.width*(r.top+1)-1]))):(r.left>0&&(t=a.resolve(l+o.map[r.top*o.width])),s.right<o.width&&(e=a.resolve(l+o.map[o.width*(s.top+1)-1]))),new g(e,t)}toJSON(){return{type:"cell",anchor:this.$anchorCell.pos,head:this.$headCell.pos}}static fromJSON(e,t){return new g(e.resolve(t.anchor),e.resolve(t.head))}static create(e,t,n=t){return new g(e.resolve(t),e.resolve(n))}getBookmark(){return new ue(this.$anchorCell.pos,this.$headCell.pos)}};g.prototype.visible=!1;M.jsonID("cell",g);var ue=class{constructor(e,t){this.anchor=e,this.head=t}map(e){return new ue(e.map(this.anchor),e.map(this.head))}resolve(e){const t=e.resolve(this.anchor),n=e.resolve(this.head);return t.parent.type.spec.tableRole=="row"&&n.parent.type.spec.tableRole=="row"&&t.index()<t.parent.childCount&&n.index()<n.parent.childCount&&G(t,n)?new g(t,n):M.near(n,1)}};function Ee(e){if(!(e.selection instanceof g))return null;const t=[];return e.selection.forEachCell((n,o)=>{t.push(ae.node(o,o+n.nodeSize,{class:"selectedCell"}))}),K.create(e.doc,t)}function Te({$from:e,$to:t}){if(e.pos==t.pos||e.pos<e.pos-6)return!1;let n=e.pos,o=t.pos,l=e.depth;for(;l>=0&&!(e.after(l+1)<e.end(l));l--,n++);for(let s=t.depth;s>=0&&!(t.before(s+1)>t.start(s));s--,o--);return n==o&&/row|table/.test(e.node(l).type.spec.tableRole)}function De({$from:e,$to:t}){let n,o;for(let l=e.depth;l>0;l--){const s=e.node(l);if(s.type.spec.tableRole==="cell"||s.type.spec.tableRole==="header_cell"){n=s;break}}for(let l=t.depth;l>0;l--){const s=t.node(l);if(s.type.spec.tableRole==="cell"||s.type.spec.tableRole==="header_cell"){o=s;break}}return n!==o&&t.parentOffset===0}function He(e,t,n){const o=(t||e).selection,l=(t||e).doc;let s,r;if(o instanceof be&&(r=o.node.type.spec.tableRole)){if(r=="cell"||r=="header_cell")s=g.create(l,o.from);else if(r=="row"){const a=l.resolve(o.from+1);s=g.rowSelection(a,a)}else if(!n){const a=C.get(o.node),i=o.from+1,c=i+a.map[a.width*a.height-1];s=g.create(l,i+1,c)}}else o instanceof k&&Te(o)?s=k.create(l,o.from):o instanceof k&&De(o)&&(s=k.create(l,o.$from.start(),o.$from.end()));return s&&(t||(t=e.tr)).setSelection(s),t}var _e=new Y("fix-tables");function he(e,t,n,o){const l=e.childCount,s=t.childCount;e:for(let r=0,a=0;r<s;r++){const i=t.child(r);for(let c=a,f=Math.min(l,r+3);c<f;c++)if(e.child(c)==i){a=c+1,n+=i.nodeSize;continue e}o(i,n),a<l&&e.child(a).sameMarkup(i)?he(e.child(a),i,n+1,o):i.nodesBetween(0,i.content.size,o,n+1),n+=i.nodeSize}}function Be(e,t){let n;const o=(l,s)=>{l.type.spec.tableRole=="table"&&(n=Le(e,l,s,n))};return t?t.doc!=e.doc&&he(t.doc,e.doc,0,o):e.doc.descendants(o),n}function Le(e,t,n,o){const l=C.get(t);if(!l.problems)return o;o||(o=e.tr);const s=[];for(let i=0;i<l.height;i++)s.push(0);for(let i=0;i<l.problems.length;i++){const c=l.problems[i];if(c.type=="collision"){const f=t.nodeAt(c.pos);if(!f)continue;const d=f.attrs;for(let u=0;u<d.rowspan;u++)s[c.row+u]+=c.n;o.setNodeMarkup(o.mapping.map(n+1+c.pos),null,E(d,d.colspan-c.n,c.n))}else if(c.type=="missing")s[c.row]+=c.n;else if(c.type=="overlong_rowspan"){const f=t.nodeAt(c.pos);if(!f)continue;o.setNodeMarkup(o.mapping.map(n+1+c.pos),null,{...f.attrs,rowspan:f.attrs.rowspan-c.n})}else if(c.type=="colwidth mismatch"){const f=t.nodeAt(c.pos);if(!f)continue;o.setNodeMarkup(o.mapping.map(n+1+c.pos),null,{...f.attrs,colwidth:c.colwidth})}}let r,a;for(let i=0;i<s.length;i++)s[i]&&(r==null&&(r=i),a=i);for(let i=0,c=n+1;i<l.height;i++){const f=t.child(i),d=c+f.nodeSize,u=s[i];if(u>0){let h="cell";f.firstChild&&(h=f.firstChild.type.spec.tableRole);const p=[];for(let m=0;m<u;m++){const x=b(e.schema)[h].createAndFill();x&&p.push(x)}const w=(i==0||r==i-1)&&a==i?c+1:d-1;o.insert(o.mapping.map(w),p)}c=d}return o.setMeta(_e,{fixTables:!0})}function $e(e){if(!e.size)return null;let{content:t,openStart:n,openEnd:o}=e;for(;t.childCount==1&&(n>0&&o>0||t.child(0).type.spec.tableRole=="table");)n--,o--,t=t.child(0).content;const l=t.child(0),s=l.type.spec.tableRole,r=l.type.schema,a=[];if(s=="row")for(let i=0;i<t.childCount;i++){let c=t.child(i).content;const f=i?0:Math.max(0,n-1),d=i<t.childCount-1?0:Math.max(0,o-1);(f||d)&&(c=J(b(r).row,new v(c,f,d)).content),a.push(c)}else if(s=="cell"||s=="header_cell")a.push(n||o?J(b(r).row,new v(t,n,o)).content:t);else return null;return Fe(r,a)}function Fe(e,t){const n=[];for(let l=0;l<t.length;l++){const s=t[l];for(let r=s.childCount-1;r>=0;r--){const{rowspan:a,colspan:i}=s.child(r).attrs;for(let c=l;c<l+a;c++)n[c]=(n[c]||0)+i}}let o=0;for(let l=0;l<n.length;l++)o=Math.max(o,n[l]);for(let l=0;l<n.length;l++)if(l>=t.length&&t.push(A.empty),n[l]<o){const s=b(e).cell.createAndFill(),r=[];for(let a=n[l];a<o;a++)r.push(s);t[l]=t[l].append(A.from(r))}return{height:t.length,width:o,rows:t}}function J(e,t){const n=e.createAndFill();return new Se(n).replace(0,n.content.size,t).doc}function Pe({width:e,height:t,rows:n},o,l){if(e!=o){const s=[],r=[];for(let a=0;a<n.length;a++){const i=n[a],c=[];for(let f=s[a]||0,d=0;f<o;d++){let u=i.child(d%i.childCount);f+u.attrs.colspan>o&&(u=u.type.createChecked(E(u.attrs,u.attrs.colspan,f+u.attrs.colspan-o),u.content)),c.push(u),f+=u.attrs.colspan;for(let h=1;h<u.attrs.rowspan;h++)s[a+h]=(s[a+h]||0)+u.attrs.colspan}r.push(A.from(c))}n=r,e=o}if(t!=l){const s=[];for(let r=0,a=0;r<l;r++,a++){const i=[],c=n[a%t];for(let f=0;f<c.childCount;f++){let d=c.child(f);r+d.attrs.rowspan>l&&(d=d.type.create({...d.attrs,rowspan:Math.max(1,l-d.attrs.rowspan)},d.content)),i.push(d)}s.push(A.from(i))}n=s,t=l}return{width:e,height:t,rows:n}}function We(e,t,n,o,l,s,r){const a=e.doc.type.schema,i=b(a);let c,f;if(l>t.width)for(let d=0,u=0;d<t.height;d++){const h=n.child(d);u+=h.nodeSize;const p=[];let w;h.lastChild==null||h.lastChild.type==i.cell?w=c||(c=i.cell.createAndFill()):w=f||(f=i.header_cell.createAndFill());for(let m=t.width;m<l;m++)p.push(w);e.insert(e.mapping.slice(r).map(u-1+o),p)}if(s>t.height){const d=[];for(let p=0,w=(t.height-1)*t.width;p<Math.max(t.width,l);p++){const m=p>=t.width?!1:n.nodeAt(t.map[w+p]).type==i.header_cell;d.push(m?f||(f=i.header_cell.createAndFill()):c||(c=i.cell.createAndFill()))}const u=i.row.create(null,A.from(d)),h=[];for(let p=t.height;p<s;p++)h.push(u);e.insert(e.mapping.slice(r).map(o+n.nodeSize-2),h)}return!!(c||f)}function ee(e,t,n,o,l,s,r,a){if(r==0||r==t.height)return!1;let i=!1;for(let c=l;c<s;c++){const f=r*t.width+c,d=t.map[f];if(t.map[f-t.width]==d){i=!0;const u=n.nodeAt(d),{top:h,left:p}=t.findCell(d);e.setNodeMarkup(e.mapping.slice(a).map(d+o),null,{...u.attrs,rowspan:r-h}),e.insert(e.mapping.slice(a).map(t.positionAt(r,p,n)),u.type.createAndFill({...u.attrs,rowspan:h+u.attrs.rowspan-r})),c+=u.attrs.colspan-1}}return i}function te(e,t,n,o,l,s,r,a){if(r==0||r==t.width)return!1;let i=!1;for(let c=l;c<s;c++){const f=c*t.width+r,d=t.map[f];if(t.map[f-1]==d){i=!0;const u=n.nodeAt(d),h=t.colCount(d),p=e.mapping.slice(a).map(d+o);e.setNodeMarkup(p,null,E(u.attrs,r-h,u.attrs.colspan-(r-h))),e.insert(p+u.nodeSize,u.type.createAndFill(E(u.attrs,0,r-h))),c+=u.attrs.rowspan-1}}return i}function oe(e,t,n,o,l){let s=n?e.doc.nodeAt(n-1):e.doc;if(!s)throw new Error("No table found");let r=C.get(s);const{top:a,left:i}=o,c=i+l.width,f=a+l.height,d=e.tr;let u=0;function h(){if(s=n?d.doc.nodeAt(n-1):d.doc,!s)throw new Error("No table found");r=C.get(s),u=d.mapping.maps.length}We(d,r,s,n,c,f,u)&&h(),ee(d,r,s,n,i,c,a,u)&&h(),ee(d,r,s,n,i,c,f,u)&&h(),te(d,r,s,n,a,f,i,u)&&h(),te(d,r,s,n,a,f,c,u)&&h();for(let p=a;p<f;p++){const w=r.positionAt(p,i,s),m=r.positionAt(p,c,s);d.replace(d.mapping.slice(u).map(w+n),d.mapping.slice(u).map(m+n),new v(l.rows[p-a],0,0))}h(),d.setSelection(new g(d.doc.resolve(n+r.positionAt(a,i,s)),d.doc.resolve(n+r.positionAt(f-1,c-1,s)))),t(d)}var Ie=ye({ArrowLeft:B("horiz",-1),ArrowRight:B("horiz",1),ArrowUp:B("vert",-1),ArrowDown:B("vert",1),"Shift-ArrowLeft":L("horiz",-1),"Shift-ArrowRight":L("horiz",1),"Shift-ArrowUp":L("vert",-1),"Shift-ArrowDown":L("vert",1),Backspace:$,"Mod-Backspace":$,Delete:$,"Mod-Delete":$});function F(e,t,n){return n.eq(e.selection)?!1:(t&&t(e.tr.setSelection(n).scrollIntoView()),!0)}function B(e,t){return(n,o,l)=>{if(!l)return!1;const s=n.selection;if(s instanceof g)return F(n,o,M.near(s.$headCell,t));if(e!="horiz"&&!s.empty)return!1;const r=pe(l,e,t);if(r==null)return!1;if(e=="horiz")return F(n,o,M.near(n.doc.resolve(s.head+t),t));{const a=n.doc.resolve(r),i=fe(a,e,t);let c;return i?c=M.near(i,1):t<0?c=M.near(n.doc.resolve(a.before(-1)),-1):c=M.near(n.doc.resolve(a.after(-1)),1),F(n,o,c)}}}function L(e,t){return(n,o,l)=>{if(!l)return!1;const s=n.selection;let r;if(s instanceof g)r=s;else{const i=pe(l,e,t);if(i==null)return!1;r=new g(n.doc.resolve(i))}const a=fe(r.$headCell,e,t);return a?F(n,o,new g(r.$anchorCell,a)):!1}}function $(e,t){const n=e.selection;if(!(n instanceof g))return!1;if(t){const o=e.tr,l=b(e.schema).cell.createAndFill().content;n.forEachCell((s,r)=>{s.content.eq(l)||o.replace(o.mapping.map(r+1),o.mapping.map(r+s.nodeSize-1),new v(l,0,0))}),o.docChanged&&t(o)}return!0}function Oe(e,t){const n=e.state.doc,o=T(n.resolve(t));return o?(e.dispatch(e.state.tr.setSelection(new g(o))),!0):!1}function je(e,t,n){if(!S(e.state))return!1;let o=$e(n);const l=e.state.selection;if(l instanceof g){o||(o={width:1,height:1,rows:[A.from(J(b(e.state.schema).cell,n))]});const s=l.$anchorCell.node(-1),r=l.$anchorCell.start(-1),a=C.get(s).rectBetween(l.$anchorCell.pos-r,l.$headCell.pos-r);return o=Pe(o,a.right-a.left,a.bottom-a.top),oe(e.state,e.dispatch,r,a,o),!0}else if(o){const s=W(e.state),r=s.start(-1);return oe(e.state,e.dispatch,r,C.get(s.node(-1)).findCell(s.pos-r),o),!0}else return!1}function Ke(e,t){var n;if(t.ctrlKey||t.metaKey)return;const o=ne(e,t.target);let l;if(t.shiftKey&&e.state.selection instanceof g)s(e.state.selection.$anchorCell,t),t.preventDefault();else if(t.shiftKey&&o&&(l=T(e.state.selection.$anchor))!=null&&((n=j(e,t))==null?void 0:n.pos)!=l.pos)s(l,t),t.preventDefault();else if(!o)return;function s(i,c){let f=j(e,c);const d=N.getState(e.state)==null;if(!f||!G(i,f))if(d)f=i;else return;const u=new g(i,f);if(d||!e.state.selection.eq(u)){const h=e.state.tr.setSelection(u);d&&h.setMeta(N,i.pos),e.dispatch(h)}}function r(){e.root.removeEventListener("mouseup",r),e.root.removeEventListener("dragstart",r),e.root.removeEventListener("mousemove",a),N.getState(e.state)!=null&&e.dispatch(e.state.tr.setMeta(N,-1))}function a(i){const c=i,f=N.getState(e.state);let d;if(f!=null)d=e.state.doc.resolve(f);else if(ne(e,c.target)!=o&&(d=j(e,t),!d))return r();d&&s(d,c)}e.root.addEventListener("mouseup",r),e.root.addEventListener("dragstart",r),e.root.addEventListener("mousemove",a)}function pe(e,t,n){if(!(e.state.selection instanceof k))return null;const{$head:o}=e.state.selection;for(let l=o.depth-1;l>=0;l--){const s=o.node(l);if((n<0?o.index(l):o.indexAfter(l))!=(n<0?0:s.childCount))return null;if(s.type.spec.tableRole=="cell"||s.type.spec.tableRole=="header_cell"){const a=o.before(l),i=t=="vert"?n>0?"down":"up":n>0?"right":"left";return e.endOfTextblock(i)?a:null}}return null}function ne(e,t){for(;t&&t!=e.dom;t=t.parentNode)if(t.nodeName=="TD"||t.nodeName=="TH")return t;return null}function j(e,t){const n=e.posAtCoords({left:t.clientX,top:t.clientY});return n&&n?T(e.state.doc.resolve(n.pos)):null}var Xe=class{constructor(e,t){this.node=e,this.cellMinWidth=t,this.dom=document.createElement("div"),this.dom.className="tableWrapper",this.table=this.dom.appendChild(document.createElement("table")),this.colgroup=this.table.appendChild(document.createElement("colgroup")),U(e,this.colgroup,this.table,t),this.contentDOM=this.table.appendChild(document.createElement("tbody"))}update(e){return e.type!=this.node.type?!1:(this.node=e,U(e,this.colgroup,this.table,this.cellMinWidth),!0)}ignoreMutation(e){return e.type=="attributes"&&(e.target==this.table||this.colgroup.contains(e.target))}};function U(e,t,n,o,l,s){var r;let a=0,i=!0,c=t.firstChild;const f=e.firstChild;if(f){for(let d=0,u=0;d<f.childCount;d++){const{colspan:h,colwidth:p}=f.child(d).attrs;for(let w=0;w<h;w++,u++){const m=l==u?s:p&&p[w],x=m?m+"px":"";a+=m||o,m||(i=!1),c?(c.style.width!=x&&(c.style.width=x),c=c.nextSibling):t.appendChild(document.createElement("col")).style.width=x}}for(;c;){const d=c.nextSibling;(r=c.parentNode)==null||r.removeChild(c),c=d}i?(n.style.width=a+"px",n.style.minWidth=""):(n.style.width="",n.style.minWidth=a+"px")}}var y=new Y("tableColumnResizing");function ht({handleWidth:e=5,cellMinWidth:t=25,View:n=Xe,lastColumnResizable:o=!0}={}){const l=new ce({key:y,state:{init(s,r){return l.spec.props.nodeViews[b(r.schema).table.name]=(a,i)=>new n(a,t,i),new P(-1,!1)},apply(s,r){return r.apply(s)}},props:{attributes:s=>{const r=y.getState(s);return r&&r.activeHandle>-1?{class:"resize-cursor"}:{}},handleDOMEvents:{mousemove:(s,r)=>{Ve(s,r,e,t,o)},mouseleave:s=>{qe(s)},mousedown:(s,r)=>{Je(s,r,t)}},decorations:s=>{const r=y.getState(s);if(r&&r.activeHandle>-1)return et(s,r.activeHandle)},nodeViews:{}}});return l}var P=class{constructor(e,t){this.activeHandle=e,this.dragging=t}apply(e){const t=this,n=e.getMeta(y);if(n&&n.setHandle!=null)return new P(n.setHandle,!1);if(n&&n.setDragging!==void 0)return new P(t.activeHandle,n.setDragging);if(t.activeHandle>-1&&e.docChanged){let o=e.mapping.map(t.activeHandle,-1);return q(e.doc.resolve(o))||(o=-1),new P(o,t.dragging)}return t}};function Ve(e,t,n,o,l){const s=y.getState(e.state);if(s&&!s.dragging){const r=Ye(t.target);let a=-1;if(r){const{left:i,right:c}=r.getBoundingClientRect();t.clientX-i<=n?a=le(e,t,"left",n):c-t.clientX<=n&&(a=le(e,t,"right",n))}if(a!=s.activeHandle){if(!l&&a!==-1){const i=e.state.doc.resolve(a),c=i.node(-1),f=C.get(c),d=i.start(-1);if(f.colCount(i.pos-d)+i.nodeAfter.attrs.colspan-1==f.width-1)return}me(e,a)}}}function qe(e){const t=y.getState(e.state);t&&t.activeHandle>-1&&!t.dragging&&me(e,-1)}function Je(e,t,n){const o=y.getState(e.state);if(!o||o.activeHandle==-1||o.dragging)return!1;const l=e.state.doc.nodeAt(o.activeHandle),s=Ue(e,o.activeHandle,l.attrs);e.dispatch(e.state.tr.setMeta(y,{setDragging:{startX:t.clientX,startWidth:s}}));function r(i){window.removeEventListener("mouseup",r),window.removeEventListener("mousemove",a);const c=y.getState(e.state);c!=null&&c.dragging&&(Ge(e,c.activeHandle,se(c.dragging,i,n)),e.dispatch(e.state.tr.setMeta(y,{setDragging:null})))}function a(i){if(!i.which)return r(i);const c=y.getState(e.state);if(c&&c.dragging){const f=se(c.dragging,i,n);Qe(e,c.activeHandle,f,n)}}return window.addEventListener("mouseup",r),window.addEventListener("mousemove",a),t.preventDefault(),!0}function Ue(e,t,{colspan:n,colwidth:o}){const l=o&&o[o.length-1];if(l)return l;const s=e.domAtPos(t);let a=s.node.childNodes[s.offset].offsetWidth,i=n;if(o)for(let c=0;c<n;c++)o[c]&&(a-=o[c],i--);return a/i}function Ye(e){for(;e&&e.nodeName!="TD"&&e.nodeName!="TH";)e=e.classList&&e.classList.contains("ProseMirror")?null:e.parentNode;return e}function le(e,t,n,o){const l=n=="right"?-o:o,s=e.posAtCoords({left:t.clientX+l,top:t.clientY});if(!s)return-1;const{pos:r}=s,a=T(e.state.doc.resolve(r));if(!a)return-1;if(n=="right")return a.pos;const i=C.get(a.node(-1)),c=a.start(-1),f=i.map.indexOf(a.pos-c);return f%i.width==0?-1:c+i.map[f-1]}function se(e,t,n){const o=t.clientX-e.startX;return Math.max(n,e.startWidth+o)}function me(e,t){e.dispatch(e.state.tr.setMeta(y,{setHandle:t}))}function Ge(e,t,n){const o=e.state.doc.resolve(t),l=o.node(-1),s=C.get(l),r=o.start(-1),a=s.colCount(o.pos-r)+o.nodeAfter.attrs.colspan-1,i=e.state.tr;for(let c=0;c<s.height;c++){const f=c*s.width+a;if(c&&s.map[f]==s.map[f-s.width])continue;const d=s.map[f],u=l.nodeAt(d).attrs,h=u.colspan==1?0:a-s.colCount(d);if(u.colwidth&&u.colwidth[h]==n)continue;const p=u.colwidth?u.colwidth.slice():Ze(u.colspan);p[h]=n,i.setNodeMarkup(r+d,null,{...u,colwidth:p})}i.docChanged&&e.dispatch(i)}function Qe(e,t,n,o){const l=e.state.doc.resolve(t),s=l.node(-1),r=l.start(-1),a=C.get(s).colCount(l.pos-r)+l.nodeAfter.attrs.colspan-1;let i=e.domAtPos(l.start(-1)).node;for(;i&&i.nodeName!="TABLE";)i=i.parentNode;i&&U(s,i.firstChild,i,o,a,n)}function Ze(e){return Array(e).fill(0)}function et(e,t){const n=[],o=e.doc.resolve(t),l=o.node(-1);if(!l)return K.empty;const s=C.get(l),r=o.start(-1),a=s.colCount(o.pos-r)+o.nodeAfter.attrs.colspan;for(let i=0;i<s.height;i++){const c=a+i*s.width-1;if((a==s.width||s.map[c]!=s.map[c+1])&&(i==0||s.map[c]!=s.map[c-s.width])){const f=s.map[c],d=r+f+l.nodeAt(f).nodeSize-1,u=document.createElement("div");u.className="column-resize-handle",n.push(ae.widget(d,u))}}return K.create(e.doc,n)}function R(e){const t=e.selection,n=W(e),o=n.node(-1),l=n.start(-1),s=C.get(o);return{...t instanceof g?s.rectBetween(t.$anchorCell.pos-l,t.$headCell.pos-l):s.findCell(n.pos-l),tableStart:l,map:s,table:o}}function ge(e,{map:t,tableStart:n,table:o},l){let s=l>0?-1:0;ke(t,o,l+s)&&(s=l==0||l==t.width?null:0);for(let r=0;r<t.height;r++){const a=r*t.width+l;if(l>0&&l<t.width&&t.map[a-1]==t.map[a]){const i=t.map[a],c=o.nodeAt(i);e.setNodeMarkup(e.mapping.map(n+i),null,de(c.attrs,l-t.colCount(i))),r+=c.attrs.rowspan-1}else{const i=s==null?b(o.type.schema).cell:o.nodeAt(t.map[a+s]).type,c=t.positionAt(r,l,o);e.insert(e.mapping.map(n+c),i.createAndFill())}}return e}function pt(e,t){if(!S(e))return!1;if(t){const n=R(e);t(ge(e.tr,n,n.left))}return!0}function mt(e,t){if(!S(e))return!1;if(t){const n=R(e);t(ge(e.tr,n,n.right))}return!0}function tt(e,{map:t,table:n,tableStart:o},l){const s=e.mapping.maps.length;for(let r=0;r<t.height;){const a=r*t.width+l,i=t.map[a],c=n.nodeAt(i),f=c.attrs;if(l>0&&t.map[a-1]==i||l<t.width-1&&t.map[a+1]==i)e.setNodeMarkup(e.mapping.slice(s).map(o+i),null,E(f,l-t.colCount(i)));else{const d=e.mapping.slice(s).map(o+i);e.delete(d,d+c.nodeSize)}r+=f.rowspan}}function gt(e,t){if(!S(e))return!1;if(t){const n=R(e),o=e.tr;if(n.left==0&&n.right==n.map.width)return!1;for(let l=n.right-1;tt(o,n,l),l!=n.left;l--){const s=n.tableStart?o.doc.nodeAt(n.tableStart-1):o.doc;if(!s)throw RangeError("No table found");n.table=s,n.map=C.get(s)}t(o)}return!0}function ot(e,t,n){var o;const l=b(t.type.schema).header_cell;for(let s=0;s<e.width;s++)if(((o=t.nodeAt(e.map[s+n*e.width]))==null?void 0:o.type)!=l)return!1;return!0}function we(e,{map:t,tableStart:n,table:o},l){var s;let r=n;for(let c=0;c<l;c++)r+=o.child(c).nodeSize;const a=[];let i=l>0?-1:0;ot(t,o,l+i)&&(i=l==0||l==t.height?null:0);for(let c=0,f=t.width*l;c<t.width;c++,f++)if(l>0&&l<t.height&&t.map[f]==t.map[f-t.width]){const d=t.map[f],u=o.nodeAt(d).attrs;e.setNodeMarkup(n+d,null,{...u,rowspan:u.rowspan+1}),c+=u.colspan-1}else{const d=i==null?b(o.type.schema).cell:(s=o.nodeAt(t.map[f+i*t.width]))==null?void 0:s.type,u=d==null?void 0:d.createAndFill();u&&a.push(u)}return e.insert(r,b(o.type.schema).row.create(null,a)),e}function wt(e,t){if(!S(e))return!1;if(t){const n=R(e);t(we(e.tr,n,n.top))}return!0}function Ct(e,t){if(!S(e))return!1;if(t){const n=R(e);t(we(e.tr,n,n.bottom))}return!0}function nt(e,{map:t,table:n,tableStart:o},l){let s=0;for(let i=0;i<l;i++)s+=n.child(i).nodeSize;const r=s+n.child(l).nodeSize,a=e.mapping.maps.length;e.delete(s+o,r+o);for(let i=0,c=l*t.width;i<t.width;i++,c++){const f=t.map[c];if(l>0&&f==t.map[c-t.width]){const d=n.nodeAt(f).attrs;e.setNodeMarkup(e.mapping.slice(a).map(f+o),null,{...d,rowspan:d.rowspan-1}),i+=d.colspan-1}else if(l<t.width&&f==t.map[c+t.width]){const d=n.nodeAt(f),u=d.attrs,h=d.type.create({...u,rowspan:d.attrs.rowspan-1},d.content),p=t.positionAt(l+1,i,n);e.insert(e.mapping.slice(a).map(o+p),h),i+=u.colspan-1}}}function bt(e,t){if(!S(e))return!1;if(t){const n=R(e),o=e.tr;if(n.top==0&&n.bottom==n.map.height)return!1;for(let l=n.bottom-1;nt(o,n,l),l!=n.top;l--){const s=n.tableStart?o.doc.nodeAt(n.tableStart-1):o.doc;if(!s)throw RangeError("No table found");n.table=s,n.map=C.get(n.table)}t(o)}return!0}function re(e){const t=e.content;return t.childCount==1&&t.child(0).isTextblock&&t.child(0).childCount==0}function lt({width:e,height:t,map:n},o){let l=o.top*e+o.left,s=l,r=(o.bottom-1)*e+o.left,a=l+(o.right-o.left-1);for(let i=o.top;i<o.bottom;i++){if(o.left>0&&n[s]==n[s-1]||o.right<e&&n[a]==n[a+1])return!0;s+=e,a+=e}for(let i=o.left;i<o.right;i++){if(o.top>0&&n[l]==n[l-e]||o.bottom<t&&n[r]==n[r+e])return!0;l++,r++}return!1}function yt(e,t){const n=e.selection;if(!(n instanceof g)||n.$anchorCell.pos==n.$headCell.pos)return!1;const o=R(e),{map:l}=o;if(lt(l,o))return!1;if(t){const s=e.tr,r={};let a=A.empty,i,c;for(let f=o.top;f<o.bottom;f++)for(let d=o.left;d<o.right;d++){const u=l.map[f*l.width+d],h=o.table.nodeAt(u);if(!(r[u]||!h))if(r[u]=!0,i==null)i=u,c=h;else{re(h)||(a=a.append(h.content));const p=s.mapping.map(u+o.tableStart);s.delete(p,p+h.nodeSize)}}if(i==null||c==null)return!0;if(s.setNodeMarkup(i+o.tableStart,null,{...de(c.attrs,c.attrs.colspan,o.right-o.left-c.attrs.colspan),rowspan:o.bottom-o.top}),a.size){const f=i+1+c.content.size,d=re(c)?i+1:f;s.replaceWith(d+o.tableStart,f+o.tableStart,a)}s.setSelection(new g(s.doc.resolve(i+o.tableStart))),t(s)}return!0}function St(e,t){const n=b(e.schema);return st(({node:o})=>n[o.type.spec.tableRole])(e,t)}function st(e){return(t,n)=>{var o;const l=t.selection;let s,r;if(l instanceof g){if(l.$anchorCell.pos!=l.$headCell.pos)return!1;s=l.$anchorCell.nodeAfter,r=l.$anchorCell.pos}else{if(s=Ne(l.$from),!s)return!1;r=(o=T(l.$from))==null?void 0:o.pos}if(s==null||r==null||s.attrs.colspan==1&&s.attrs.rowspan==1)return!1;if(n){let a=s.attrs;const i=[],c=a.colwidth;a.rowspan>1&&(a={...a,rowspan:1}),a.colspan>1&&(a={...a,colspan:1});const f=R(t),d=t.tr;for(let h=0;h<f.right-f.left;h++)i.push(c?{...a,colwidth:c&&c[h]?[c[h]]:null}:a);let u;for(let h=f.top;h<f.bottom;h++){let p=f.map.positionAt(h,f.left,f.table);h==f.top&&(p+=s.nodeSize);for(let w=f.left,m=0;w<f.right;w++,m++)w==f.left&&h==f.top||d.insert(u=d.mapping.map(p+f.tableStart,1),e({node:s,row:h,col:w}).createAndFill(i[m]))}d.setNodeMarkup(r,e({node:s,row:f.top,col:f.left}),i[0]),l instanceof g&&d.setSelection(new g(d.doc.resolve(l.$anchorCell.pos),u?d.doc.resolve(u):void 0)),n(d)}return!0}}function At(e,t){return function(n,o){if(!S(n))return!1;const l=W(n);if(l.nodeAfter.attrs[e]===t)return!1;if(o){const s=n.tr;n.selection instanceof g?n.selection.forEachCell((r,a)=>{r.attrs[e]!==t&&s.setNodeMarkup(a,null,{...r.attrs,[e]:t})}):s.setNodeMarkup(l.pos,null,{...l.nodeAfter.attrs,[e]:t}),o(s)}return!0}}function rt(e){return function(t,n){if(!S(t))return!1;if(n){const o=b(t.schema),l=R(t),s=t.tr,r=l.map.cellsInRect(e=="column"?{left:l.left,top:0,right:l.right,bottom:l.map.height}:e=="row"?{left:0,top:l.top,right:l.map.width,bottom:l.bottom}:l),a=r.map(i=>l.table.nodeAt(i));for(let i=0;i<r.length;i++)a[i].type==o.header_cell&&s.setNodeMarkup(l.tableStart+r[i],o.cell,a[i].attrs);if(s.steps.length==0)for(let i=0;i<r.length;i++)s.setNodeMarkup(l.tableStart+r[i],o.header_cell,a[i].attrs);n(s)}return!0}}function ie(e,t,n){const o=t.map.cellsInRect({left:0,top:0,right:e=="row"?t.map.width:1,bottom:e=="column"?t.map.height:1});for(let l=0;l<o.length;l++){const s=t.table.nodeAt(o[l]);if(s&&s.type!==n.header_cell)return!1}return!0}function Q(e,t){return t=t||{useDeprecatedLogic:!1},t.useDeprecatedLogic?rt(e):function(n,o){if(!S(n))return!1;if(o){const l=b(n.schema),s=R(n),r=n.tr,a=ie("row",s,l),i=ie("column",s,l),f=(e==="column"?a:e==="row"?i:!1)?1:0,d=e=="column"?{left:0,top:f,right:1,bottom:s.map.height}:e=="row"?{left:f,top:0,right:s.map.width,bottom:1}:s,u=e=="column"?i?l.cell:l.header_cell:e=="row"?a?l.cell:l.header_cell:l.cell;s.map.cellsInRect(d).forEach(h=>{const p=h+s.tableStart,w=r.doc.nodeAt(p);w&&r.setNodeMarkup(p,u,w.attrs)}),o(r)}return!0}}Q("row",{useDeprecatedLogic:!0});Q("column",{useDeprecatedLogic:!0});var Rt=Q("cell",{useDeprecatedLogic:!0});function it(e,t){if(t<0){const n=e.nodeBefore;if(n)return e.pos-n.nodeSize;for(let o=e.index(-1)-1,l=e.before();o>=0;o--){const s=e.node(-1).child(o),r=s.lastChild;if(r)return l-1-r.nodeSize;l-=s.nodeSize}}else{if(e.index()<e.parent.childCount-1)return e.pos+e.nodeAfter.nodeSize;const n=e.node(-1);for(let o=e.indexAfter(-1),l=e.after();o<n.childCount;o++){const s=n.child(o);if(s.childCount)return l+1;l+=s.nodeSize}}return null}function xt(e){return function(t,n){if(!S(t))return!1;const o=it(W(t),e);if(o==null)return!1;if(n){const l=t.doc.resolve(o);n(t.tr.setSelection(k.between(l,ze(l))).scrollIntoView())}return!0}}function Mt(e,t){const n=e.selection.$anchor;for(let o=n.depth;o>0;o--)if(n.node(o).type.spec.tableRole=="table")return t&&t(e.tr.delete(n.before(o),n.after(o)).scrollIntoView()),!0;return!1}function Nt({allowTableNodeSelection:e=!1}={}){return new ce({key:N,state:{init(){return null},apply(t,n){const o=t.getMeta(N);if(o!=null)return o==-1?null:o;if(n==null||!t.docChanged)return n;const{deleted:l,pos:s}=t.mapping.mapResult(n);return l?null:s}},props:{decorations:Ee,handleDOMEvents:{mousedown:Ke},createSelectionBetween(t){return N.getState(t.state)!=null?t.state.selection:null},handleTripleClick:Oe,handleKeyDown:Ie,handlePaste:je},appendTransaction(t,n,o){return He(o,Be(o,n),e)}})}export{g as C,pt as a,mt as b,wt as c,gt as d,Ct as e,bt as f,Mt as g,Rt as h,At as i,xt as j,Be as k,ht as l,yt as m,Nt as n,St as s,Q as t};
